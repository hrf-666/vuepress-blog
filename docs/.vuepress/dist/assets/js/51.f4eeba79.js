(window.webpackJsonp=window.webpackJsonp||[]).push([[51],{389:function(s,t,e){s.exports=e.p+"assets/img/6.Java连接Redis经典故障.798e6c8d.png"},390:function(s,t,e){s.exports=e.p+"assets/img/7.将Lettuce二方包仲裁掉.b316e192.png"},391:function(s,t,e){s.exports=e.p+"assets/img/8.刷新节点集群拓扑动态感应官网说明.91c91032.png"},755:function(s,t,e){"use strict";e.r(t);var a=e(5),n=Object(a.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"redistemplate连接集群"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#redistemplate连接集群"}},[s._v("#")]),s._v(" RedisTemplate连接集群")]),s._v(" "),t("p",[s._v("启动Redis集群6台实例")]),s._v(" "),t("p",[s._v("第一次改写YML")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ===========================redis集群===========================")]),s._v("\nspring.redis.password=123456\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 获取失败 最大重定向次数")]),s._v("\nspring.redis.cluster.max"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("redirects=3\nspring.redis.lettuce.pool.max"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("active=8\nspring.redis.1ettuce.pool.max"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("wait="),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("1ms\nspring.redis.1ettuce.pool.max"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("idle=8\nspring.redis.lettuce.pool.min"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("idle=0\nspring.redis.cluster.nodes=192.168.111.175"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6381")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("192.168.111.175"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6382")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("192.168.111.176"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6383")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("192.168.111.176"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6384")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("p",[s._v("直接通过微服务访问Redis集群")]),s._v(" "),t("p",[s._v("一切正常 （http://localhost:7777/swagger-ui.html）")]),s._v(" "),t("p",[s._v("$\\textcolor{red}{\\large 问题来了}$")]),s._v(" "),t("ol",[t("li",[t("p",[s._v("人为模拟，master-6381机器意外宕机，手动shutdown")])]),s._v(" "),t("li",[t("p",[s._v("先对redis集群用命令的方式，手动验证各种读写命令，看看6384是否上位")])]),s._v(" "),t("li",[t("p",[s._v("Redis Cluster集群能自动感知并自动完成主备切换，对应的slave6384会被选举为新的master节点")])]),s._v(" "),t("li",[t("p",[s._v("通过redis客户端连接6384可以正常进行读写操作")])]),s._v(" "),t("li",[t("p",[s._v("$\\textcolor{green}{\\large 微服务客户端再次读写访问试试}$")]),s._v(" "),t("p",[s._v("故障现象")]),s._v(" "),t("p",[s._v("SpringBoot客户端没有动态感知RedisCluster的最新集群信息")]),s._v(" "),t("p",[s._v("金典故障")]),s._v(" "),t("p",[s._v("【故障演练】 Redis Cluster集群部署采用了3主3从拓扑结构，数据读写访问master节点，slave节点负责备份。$\\textcolor{red}{\\large 当master宕机主从切换成功，redis手动OK，but 2个经典故障}$")]),s._v(" "),t("p",[t("img",{attrs:{src:e(389),alt:""}})]),s._v(" "),t("p",[s._v("导致原因\nSpringBoot 2.X版本，Redis默认的连接池采用Lettuce，当Redis集群节点发生变化后，Letture默认是不会刷新节点拓扑")]),s._v(" "),t("p",[s._v("解决方案")]),s._v(" "),t("ol",[t("li",[t("p",[s._v("排除lettuce采用Jedis（不推荐）")]),s._v(" "),t("p",[t("img",{attrs:{src:e(390),alt:""}})])]),s._v(" "),t("li",[t("p",[s._v("重写连接工厂实例（极度不推荐）")])]),s._v(" "),t("li",[t("p",[s._v("刷新节点集群拓扑动态感应")]),s._v(" "),t("p",[t("img",{attrs:{src:e(391),alt:""}})]),s._v(" "),t("p",[s._v("解决方法：")]),s._v(" "),t("p",[s._v("调用 RedisClusterClient.reloadPartitions\n后台基于时间间隔的周期刷新\n后台基于持续的 "),t("strong",[s._v("断开")]),s._v(" 和 "),t("strong",[s._v("移动")]),s._v("、"),t("strong",[s._v("重定向")]),s._v(" 的自适应更新")])])])])])])}),[],!1,null,null,null);t.default=n.exports}}]);